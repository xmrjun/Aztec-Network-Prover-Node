# Aztec Prover 节点运行教程 - 简化版

## 🚀 快速开始

### 1. 系统要求
- **CPU**: 64核心+
- **内存**: 256GB+
- **存储**: 1TB+ SSD
- **系统**: Ubuntu 20.04+

### 2. 安装Docker
```bash
# 移除旧版本
sudo apt update -y && sudo apt upgrade -y
for pkg in docker.io docker-doc docker-compose podman-docker containerd runc; do 
    sudo apt-get remove $pkg; 
done

# 安装官方Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo systemctl enable docker
sudo systemctl start docker

# 验证安装
docker --version
```

### 3. 安装Aztec工具
```bash
# 安装Aztec CLI
bash -i <(curl -s https://install.aztec.network)

# 添加到PATH
echo 'export PATH="$HOME/.aztec/bin:$PATH"' >> ~/.bashrc
source ~/.bashrc

# 验证
aztec -V
```

### 4. 配置节点

#### 创建工作目录
```bash
mkdir -p ~/prover && cd ~/prover
```

#### 配置环境变量 (.env文件)
```bash
cat > .env << 'EOF'
# 替换为您的实际配置
P2P_IP=YOUR_VPS_IP_ADDRESS
ETHEREUM_HOSTS=https://eth-sepolia.g.alchemy.com/v2/YOUR_API_KEY
L1_CONSENSUS_HOST_URLS=https://beacon-nd-123-456-789.p2pify.com/YOUR_API_KEY
PROVER_PUBLISHER_PRIVATE_KEY=0xYOUR_PRIVATE_KEY
PROVER_ID=0xYOUR_WALLET_ADDRESS
EOF
```

#### Docker Compose配置 (docker-compose.yml)
```bash
cat > docker-compose.yml << 'EOF'
name: aztec-prover
services:
  prover-node:
    image: aztecprotocol/aztec:latest
    environment:
      P2P_ENABLED: "true"
      DATA_DIRECTORY: /data-prover
      P2P_IP: ${P2P_IP}
      DATA_STORE_MAP_SIZE_KB: "134217728"
      ETHEREUM_HOSTS: ${ETHEREUM_HOSTS}
      L1_CONSENSUS_HOST_URLS: ${L1_CONSENSUS_HOST_URLS}
      LOG_LEVEL: info
      PROVER_BROKER_HOST: http://broker:8080
      PROVER_PUBLISHER_PRIVATE_KEY: ${PROVER_PUBLISHER_PRIVATE_KEY}
      NODE_OPTIONS: "--max-old-space-size=102400"
      UV_THREADPOOL_SIZE: "16"
    ports:
      - "8080:8080"
      - "40400:40400"
      - "40400:40400/udp"
    volumes:
      - ./data-prover:/data-prover
    deploy:
      resources:
        limits:
          memory: 120G
          cpus: '32'
    restart: unless-stopped
    depends_on:
      - broker
    entrypoint: >
      sh -c 'node --no-warnings /usr/src/yarn-project/aztec/dest/bin/index.js start --network alpha-testnet --archiver --prover-node'

  agent:
    image: aztecprotocol/aztec:latest
    environment:
      PROVER_AGENT_COUNT: "8"
      PROVER_AGENT_POLL_INTERVAL_MS: "10000"
      PROVER_BROKER_HOST: http://broker:8080
      PROVER_ID: ${PROVER_ID}
      NODE_OPTIONS: "--max-old-space-size=25600"
    deploy:
      resources:
        limits:
          memory: 40G
          cpus: '16'
    restart: unless-stopped
    volumes:
      - ./data-prover:/data-prover
    entrypoint: >
      sh -c 'node --no-warnings /usr/src/yarn-project/aztec/dest/bin/index.js start --network alpha-testnet --prover-agent'

  broker:
    image: aztecprotocol/aztec:latest
    environment:
      DATA_DIRECTORY: /data-broker
      LOG_LEVEL: info
      ETHERNET_HOSTS: ${ETHEREUM_HOSTS}
      P2P_IP: ${P2P_IP}
      NODE_OPTIONS: "--max-old-space-size=15360"
    deploy:
      resources:
        limits:
          memory: 20G
          cpus: '8'
    volumes:
      - ./data-broker:/data-broker
    restart: unless-stopped
    entrypoint: >
      sh -c 'node --no-warnings /usr/src/yarn-project/aztec/dest/bin/index.js start --network alpha-testnet --prover-broker'
EOF
```

### 5. 启动节点
```bash
# 启动所有服务
docker compose up -d

# 检查状态
docker ps
```

### 6. 监控节点
```bash
# 查看日志
docker logs -f aztec-prover-prover-node-1

# 检查资源使用
docker stats

# 查看证明生成
docker logs aztec-prover-prover-node-1 | grep "Generated proof"
```

## 🔧 常见问题

### Broker连接失败
```bash
# 重启服务
docker compose restart

# 检查连接
docker exec aztec-prover-prover-node-1 curl -s http://broker:8080/health
```

### 内存不足
```bash
# 减少Agent数量
sed -i 's/PROVER_AGENT_COUNT: "8"/PROVER_AGENT_COUNT: "4"/g' docker-compose.yml
docker compose restart aztec-prover-agent-1
```

### 查看同步状态
```bash
# 检查P2P连接
docker logs aztec-prover-prover-node-1 | grep "Connected to.*peers"

# 查看区块同步
docker logs aztec-prover-prover-node-1 | grep "Downloaded L2 block"
```

## 📊 快速监控脚本
```bash
cat > quick_monitor.sh << 'EOF'
#!/bin/bash
echo "=== Aztec Prover 状态 ==="
echo "容器状态:"
docker ps --format "table {{.Names}}\t{{.Status}}" | grep aztec-prover

echo -e "\n内存使用:"
free -h | head -2

echo -e "\n最新活动:"
docker logs --tail 3 aztec-prover-prover-node-1 | grep -E "Generated proof|Downloaded.*block" || echo "暂无活动"
EOF

chmod +x quick_monitor.sh
./quick_monitor.sh
```

## ⚡ 性能调优

### 根据硬件优化Agent数量
```bash
# 获取CPU核心数并计算合理的Agent数量
CPU_CORES=$(nproc)
AGENT_COUNT=$((CPU_CORES / 8))
echo "建议Agent数量: $AGENT_COUNT"

# 应用配置
sed -i "s/PROVER_AGENT_COUNT: \"[0-9]*\"/PROVER_AGENT_COUNT: \"$AGENT_COUNT\"/g" docker-compose.yml
docker compose restart aztec-prover-agent-1
```

## 🎯 重要提醒

1. **首次启动需要等待**: 下载CRS文件和同步可能需要1-2小时
2. **监控资源使用**: 避免Agent数量过多导致系统过载
3. **定期检查日志**: 确保节点正常生成证明
4. **备份配置**: 保存好.env文件和私钥

## 📞 需要帮助？

如果遇到问题，可以：
- 查看完整教程: `Aztec_Prover_完整运行教程.md`
- 使用故障排除指南: `Aztec_Prover_故障排除指南.md`
- 运行监控脚本: `monitor_prover.sh`

祝您运行成功！🚀