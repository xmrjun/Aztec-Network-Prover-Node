# Aztec Prover 优化配置 - 128核心/377GB专用

## 🚀 您的硬件配置
- **CPU**: 128核心 ⭐⭐⭐
- **内存**: 377GB ⭐⭐⭐
- **存储**: 1.8TB NVMe SSD ⭐⭐⭐
- **系统**: Linux专用服务器

**评估**: 顶级配置，可以运行高性能Prover节点！

## 🎯 优化建议

基于您的128核心配置，我们可以使用更激进的Agent配置：

### 方案一：保守配置（推荐开始）
- **Agent数量**: 16个
- **总内存使用**: ~250GB
- **CPU使用**: ~80核心

### 方案二：高性能配置
- **Agent数量**: 32个  
- **总内存使用**: ~320GB
- **CPU使用**: ~120核心

### 方案三：极限配置（实验性）
- **Agent数量**: 64个
- **总内存使用**: ~360GB
- **CPU使用**: 全部128核心

## 📋 优化配置文件

### 保守配置 Docker Compose (推荐)
```bash
mkdir -p ~/prover && cd ~/prover

# 创建环境变量文件
cat > .env << 'EOF'
# 替换为您的实际配置
P2P_IP=YOUR_VPS_IP_ADDRESS
ETHEREUM_HOSTS=https://eth-sepolia.g.alchemy.com/v2/YOUR_API_KEY
L1_CONSENSUS_HOST_URLS=https://beacon-nd-123-456-789.p2pify.com/YOUR_API_KEY
PROVER_PUBLISHER_PRIVATE_KEY=0xYOUR_PRIVATE_KEY
PROVER_ID=0xYOUR_WALLET_ADDRESS
EOF

# 创建Docker Compose配置
cat > docker-compose.yml << 'EOF'
name: aztec-prover
services:
  prover-node:
    image: aztecprotocol/aztec:latest
    environment:
      P2P_ENABLED: "true"
      DATA_DIRECTORY: /data-prover
      P2P_IP: ${P2P_IP}
      DATA_STORE_MAP_SIZE_KB: "134217728"
      ETHEREUM_HOSTS: ${ETHEREUM_HOSTS}
      L1_CONSENSUS_HOST_URLS: ${L1_CONSENSUS_HOST_URLS}
      LOG_LEVEL: info
      PROVER_BROKER_HOST: http://broker:8080
      PROVER_PUBLISHER_PRIVATE_KEY: ${PROVER_PUBLISHER_PRIVATE_KEY}
      NODE_OPTIONS: "--max-old-space-size=153600"  # 150GB
      UV_THREADPOOL_SIZE: "32"
    ports:
      - "8080:8080"
      - "40400:40400"
      - "40400:40400/udp"
    volumes:
      - ./data-prover:/data-prover
    deploy:
      resources:
        limits:
          memory: 180G
          cpus: '64'
        reservations:
          memory: 120G
          cpus: '32'
    restart: unless-stopped
    depends_on:
      - broker
    entrypoint: >
      sh -c 'node --no-warnings /usr/src/yarn-project/aztec/dest/bin/index.js start --network alpha-testnet --archiver --prover-node'

  agent:
    image: aztecprotocol/aztec:latest
    environment:
      PROVER_AGENT_COUNT: "16"  # 16个Agent
      PROVER_AGENT_POLL_INTERVAL_MS: "5000"  # 更频繁轮询
      PROVER_BROKER_HOST: http://broker:8080
      PROVER_ID: ${PROVER_ID}
      NODE_OPTIONS: "--max-old-space-size=51200"  # 50GB
    deploy:
      resources:
        limits:
          memory: 80G
          cpus: '48'
        reservations:
          memory: 40G
          cpus: '24'
    restart: unless-stopped
    volumes:
      - ./data-prover:/data-prover
    entrypoint: >
      sh -c 'node --no-warnings /usr/src/yarn-project/aztec/dest/bin/index.js start --network alpha-testnet --prover-agent'

  broker:
    image: aztecprotocol/aztec:latest
    environment:
      DATA_DIRECTORY: /data-broker
      LOG_LEVEL: info
      ETHEREUM_HOSTS: ${ETHEREUM_HOSTS}
      P2P_IP: ${P2P_IP}
      NODE_OPTIONS: "--max-old-space-size=25600"  # 25GB
    deploy:
      resources:
        limits:
          memory: 40G
          cpus: '16'
        reservations:
          memory: 20G
          cpus: '8'
    volumes:
      - ./data-broker:/data-broker
    restart: unless-stopped
    entrypoint: >
      sh -c 'node --no-warnings /usr/src/yarn-project/aztec/dest/bin/index.js start --network alpha-testnet --prover-broker'
EOF
```

### 高性能配置 (32 Agents)
```bash
# 如果保守配置运行稳定，可以尝试这个配置
cat > docker-compose-high-performance.yml << 'EOF'
name: aztec-prover
services:
  prover-node:
    image: aztecprotocol/aztec:latest
    environment:
      P2P_ENABLED: "true"
      DATA_DIRECTORY: /data-prover
      P2P_IP: ${P2P_IP}
      DATA_STORE_MAP_SIZE_KB: "134217728"
      ETHEREUM_HOSTS: ${ETHEREUM_HOSTS}
      L1_CONSENSUS_HOST_URLS: ${L1_CONSENSUS_HOST_URLS}
      LOG_LEVEL: info
      PROVER_BROKER_HOST: http://broker:8080
      PROVER_PUBLISHER_PRIVATE_KEY: ${PROVER_PUBLISHER_PRIVATE_KEY}
      NODE_OPTIONS: "--max-old-space-size=204800"  # 200GB
      UV_THREADPOOL_SIZE: "64"
    ports:
      - "8080:8080"
      - "40400:40400"
      - "40400:40400/udp"
    volumes:
      - ./data-prover:/data-prover
    deploy:
      resources:
        limits:
          memory: 240G
          cpus: '80'
        reservations:
          memory: 180G
          cpus: '40'
    restart: unless-stopped
    depends_on:
      - broker
    entrypoint: >
      sh -c 'node --no-warnings /usr/src/yarn-project/aztec/dest/bin/index.js start --network alpha-testnet --archiver --prover-node'

  agent:
    image: aztecprotocol/aztec:latest
    environment:
      PROVER_AGENT_COUNT: "32"  # 32个Agent
      PROVER_AGENT_POLL_INTERVAL_MS: "3000"
      PROVER_BROKER_HOST: http://broker:8080
      PROVER_ID: ${PROVER_ID}
      NODE_OPTIONS: "--max-old-space-size=76800"  # 75GB
    deploy:
      resources:
        limits:
          memory: 120G
          cpus: '64'
        reservations:
          memory: 60G
          cpus: '32'
    restart: unless-stopped
    volumes:
      - ./data-prover:/data-prover
    entrypoint: >
      sh -c 'node --no-warnings /usr/src/yarn-project/aztec/dest/bin/index.js start --network alpha-testnet --prover-agent'

  broker:
    image: aztecprotocol/aztec:latest
    environment:
      DATA_DIRECTORY: /data-broker
      LOG_LEVEL: info
      ETHEREUM_HOSTS: ${ETHEREUM_HOSTS}
      P2P_IP: ${P2P_IP}
      NODE_OPTIONS: "--max-old-space-size=32768"  # 32GB
    deploy:
      resources:
        limits:
          memory: 50G
          cpus: '16'
        reservations:
          memory: 25G
          cpus: '8'
    volumes:
      - ./data-broker:/data-broker
    restart: unless-stopped
    entrypoint: >
      sh -c 'node --no-warnings /usr/src/yarn-project/aztec/dest/bin/index.js start --network alpha-testnet --prover-broker'
EOF
```

## 🚀 快速部署脚本

```bash
# 创建一键部署脚本
cat > deploy_aztec_128core.sh << 'EOF'
#!/bin/bash
set -e

echo "🚀 部署Aztec Prover - 128核心优化版"
echo "=================================="

# 检查系统资源
echo "📊 系统资源检查:"
echo "CPU核心: $(nproc)"
echo "总内存: $(free -h | awk 'NR==2{print $2}')"
echo "可用存储: $(df -h / | awk 'NR==2{print $4}')"
echo ""

# 创建工作目录
mkdir -p ~/prover
cd ~/prover

# 设置系统优化参数
echo "⚙️ 优化系统参数..."
sudo sysctl -w vm.max_map_count=262144
sudo sysctl -w fs.file-max=1000000
sudo sysctl -w net.core.rmem_max=134217728
sudo sysctl -w net.core.wmem_max=134217728

# 检查Docker
if ! command -v docker &> /dev/null; then
    echo "❌ Docker未安装，请先安装Docker"
    exit 1
fi

echo "✅ Docker已安装: $(docker --version)"

# 提示用户配置环境变量
if [ ! -f .env ]; then
    echo "⚠️ 请先创建.env文件并配置以下变量:"
    echo "P2P_IP=YOUR_VPS_IP_ADDRESS"
    echo "ETHEREUM_HOSTS=https://eth-sepolia.g.alchemy.com/v2/YOUR_API_KEY"
    echo "L1_CONSENSUS_HOST_URLS=https://beacon-nd-123-456-789.p2pify.com/YOUR_API_KEY"
    echo "PROVER_PUBLISHER_PRIVATE_KEY=0xYOUR_PRIVATE_KEY"
    echo "PROVER_ID=0xYOUR_WALLET_ADDRESS"
    echo ""
    echo "创建后再次运行此脚本"
    exit 1
fi

# 启动服务
echo "🚀 启动Aztec Prover服务..."
docker compose up -d

echo "⏳ 等待30秒服务启动..."
sleep 30

# 检查状态
echo "📋 容器状态:"
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep aztec-prover

echo ""
echo "🎉 部署完成！"
echo ""
echo "📊 监控命令:"
echo "docker logs -f aztec-prover-prover-node-1     # 查看主节点日志"
echo "docker stats                                   # 查看资源使用"
echo "./monitor_128core.sh                          # 运行监控脚本"

EOF

chmod +x deploy_aztec_128core.sh
```

## 📊 专用监控脚本

```bash
# 创建128核心专用监控脚本
cat > monitor_128core.sh << 'EOF'
#!/bin/bash

echo "🔍 Aztec Prover 128核心监控 - $(date)"
echo "================================================"

# 容器状态
echo "📦 容器状态:"
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Image}}" | grep aztec-prover || echo "❌ 容器未运行"

echo ""

# 资源使用详情
echo "💾 详细资源使用:"
docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}" | grep aztec-prover || echo "❌ 无法获取资源信息"

echo ""

# 系统资源
echo "🖥️ 系统资源:"
echo "CPU: $(nproc)核心"
echo "内存: $(free -h | awk 'NR==2{printf "已用 %s / 总计 %s (%.1f%%)", $3, $2, ($3/$2)*100}')"
echo "磁盘: $(df -h / | awk 'NR==2{printf "已用 %s / 总计 %s (%s)", $3, $2, $5}')"

echo ""

# Broker连接检查
echo "🔗 服务连接:"
if docker exec aztec-prover-prover-node-1 curl -s http://broker:8080/health >/dev/null 2>&1; then
    echo "✅ Broker连接正常"
else
    echo "❌ Broker连接失败"
fi

echo ""

# 最新活动
echo "📋 最新活动 (最近10条):"
docker logs --tail 10 aztec-prover-prover-node-1 2>&1 | grep -E "Generated proof|Downloaded.*block|Connected.*peers|TUBE_PROOF.*completed" | tail -5 || echo "暂无相关活动"

echo ""

# Agent工作状态
echo "⚡ Agent工作状态:"
agent_logs=$(docker logs --tail 50 aztec-prover-agent-1 2>&1)
if echo "$agent_logs" | grep -q "started"; then
    agent_count=$(echo "$agent_logs" | grep -o "PROVER_AGENT_COUNT.*" | tail -1 || echo "未知")
    echo "✅ Agent正在运行 ($agent_count)"
else
    echo "❌ Agent状态异常"
fi

echo ""

# P2P网络状态
echo "🌐 P2P网络:"
p2p_info=$(docker logs --tail 20 aztec-prover-prover-node-1 2>&1 | grep -i "connected.*peers" | tail -1)
if [ -n "$p2p_info" ]; then
    echo "✅ $p2p_info"
else
    echo "⏳ 正在连接P2P网络..."
fi

echo ""
echo "🔄 使用 'watch -n 30 ./monitor_128core.sh' 进行持续监控"

EOF

chmod +x monitor_128core.sh
```

## ⚡ 性能调优建议

### 1. 渐进式部署策略
```bash
# 第一阶段：从16个Agent开始
echo "PROVER_AGENT_COUNT=16" >> .env

# 监控1小时，如果稳定则升级到32个
# sed -i 's/PROVER_AGENT_COUNT=16/PROVER_AGENT_COUNT=32/' .env
# docker compose restart aztec-prover-agent-1
```

### 2. 系统优化命令
```bash
# 优化内核参数
sudo tee -a /etc/sysctl.conf << EOF
vm.max_map_count=262144
fs.file-max=1000000
net.core.rmem_max=134217728
net.core.wmem_max=134217728
net.ipv4.tcp_rmem=4096 87380 134217728
net.ipv4.tcp_wmem=4096 65536 134217728
EOF

sudo sysctl -p
```

### 3. Docker优化
```bash
# 创建Docker守护进程配置
sudo tee /etc/docker/daemon.json << EOF
{
  "default-ulimits": {
    "nofile": {
      "Name": "nofile",
      "Hard": 1000000,
      "Soft": 1000000
    }
  },
  "max-concurrent-downloads": 10,
  "max-concurrent-uploads": 10
}
EOF

sudo systemctl restart docker
```

## 🎯 预期性能

基于您的128核心/377GB配置：

- **16 Agents**: 预期证明生成速度提升4-6倍
- **32 Agents**: 预期证明生成速度提升8-12倍
- **内存使用**: 预计250-320GB
- **CPU使用**: 预计80-120核心

## 🚨 重要提醒

1. **从保守配置开始**: 先运行16 Agent配置
2. **监控资源使用**: 密切关注内存和CPU使用
3. **逐步升级**: 稳定后再考虑32 Agent配置
4. **备份配置**: 保存好所有配置文件

您的硬件配置可以运行非常高性能的Prover节点！建议先从16 Agent的保守配置开始测试。